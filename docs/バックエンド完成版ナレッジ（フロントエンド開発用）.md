# 📋 バックエンド完成版ナレッジ（フロントエンド開発用）

## 🎯 プロジェクト概要

**在庫管理システム - バックエンドAPI完成版**
- **目的**: 製造業向け在庫・調達・生産計画管理
- **技術**: Node.js + Express.js + MySQL
- **認証**: JWT認証 + ロールベース権限管理
- **特徴**: 統合入荷処理API実装済み（2段階処理問題解決）

## 🏗 システム構成

### サーバー構成
```
📂 プロジェクト構造
├── src/
│   ├── routes/           # APIルート（全統一パターン適用済み）
│   ├── middleware/       # 認証・権限管理
│   └── utils/           # ユーティリティ関数
├── sql/                 # データベース設定・初期データ
├── docker-compose.yml   # Docker環境
└── server.js           # メインサーバー
```

### データベース構造
- **MySQL 8.0** (Docker環境)
- **UTF-8対応** (charset: utf8mb4)
- **主要テーブル**: users, parts, inventory, scheduled_receipts, production_plans, bom_items

## 🔐 認証・権限システム

### 権限レベル
```javascript
// 権限マトリックス
admin              // 全権限
production_manager // 生産計画・BOM管理
material_staff     // 在庫・入出庫・棚おろし
viewer            // 参照のみ
```

### 認証フロー
```bash
# ログイン
POST /api/auth/login
Body: {"username": "admin", "password": "admin123"}
Response: {"token": "JWT_TOKEN", "user": {...}}

# API呼び出し
Header: "Authorization: Bearer JWT_TOKEN"
```

## 📡 APIエンドポイント一覧

### 🔒 認証API
- `POST /api/auth/login` - ログイン

### 📦 在庫管理API
- `GET /api/inventory` - 在庫一覧
- `POST /api/inventory/:part_code/receipt` - 従来入荷処理
- `POST /api/inventory/:part_code/integrated-receipt` - **統合入荷処理（新機能）**
- `POST /api/inventory/:part_code/issue` - 出庫処理

### 📋 予定入荷API
- `GET /api/scheduled-receipts` - 予定入荷一覧
- `POST /api/scheduled-receipts` - 発注登録
- `PUT /api/scheduled-receipts/:id/delivery-response` - 納期回答
- `PUT /api/scheduled-receipts/:id/mark-received` - 入荷実績反映（従来）

### 🔍 利用可能在庫API
- `GET /api/available-inventory` - 全部品利用可能在庫
- `GET /api/available-inventory/:part_code` - 部品別詳細

### 🏭 生産計画API
- `GET /api/plans` - 生産計画一覧
- `POST /api/plans` - 生産計画登録（在庫予約付き）
- `POST /api/plans/:id/requirements` - 所要量計算

### 🔧 部品マスタAPI
- `GET /api/parts` - 部品一覧
- `POST /api/parts` - 部品登録

### 📊 BOM管理API
- `GET /api/bom/products` - 製品一覧
- `GET /api/bom/products/:productCode/stations/:stationCode/parts` - 使用部品一覧
- `POST /api/bom/items` - BOM項目追加

### 📈 レポートAPI
- `GET /api/reports/dashboard` - ダッシュボード
- `GET /api/reports/shortage-parts` - 不足部品レポート
- `GET /api/reports/scheduled-receipts` - 予定入荷レポート

## ⚡ 重要な実装成果

### 🔄 統合入荷処理API（最重要）
**従来の問題**: 2段階処理（予定入荷ステータス更新 + 在庫更新）の煩わしさ
**解決策**: 1回のAPI呼び出しで完結する統合処理

```javascript
// 統合入荷処理API
POST /api/inventory/:part_code/integrated-receipt
{
  "quantity": 45,
  "supplier": "Test_Supplier",
  "receipt_date": "2025-08-15",
  "scheduled_receipt_id": 123,  // 予定入荷連携時のみ
  "remarks": "統合処理テスト"
}
```

**利点**:
- ✅ ユーザビリティ向上（1回で完結）
- ✅ データ整合性保証（トランザクション）
- ✅ 運用ミス削減
- ✅ 既存API互換性維持

### 🛡 統一パターン適用
全APIファイルに以下パターンを適用済み：
- **DB接続**: mysql2/promise方式
- **認証保護**: authenticateToken + 権限チェック
- **エラーハンドリング**: try-catch-finally + 自動ロールバック
- **レスポンス形式**: {success, data, message}統一

## 🧪 テスト・動作確認

### 基本テストフロー
```bash
# 1. 認証取得
./login.sh admin
export TOKEN="取得したトークン"

# 2. 在庫確認
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3000/api/inventory"

# 3. 統合入荷処理テスト
curl -X POST \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"quantity":10,"supplier":"Test","receipt_date":"2025-07-30"}' \
  "http://localhost:3000/api/inventory/SUS304-M6-20-HEX/integrated-receipt"
```

## 🌐 フロントエンド開発向け情報

### 推奨技術スタック
- **React 18 + TypeScript**
- **Next.js 14** (App Router)
- **Tailwind CSS** (スタイリング)
- **React Hook Form** (フォーム管理)
- **TanStack Query** (API状態管理)

### API連携パターン
```typescript
// API呼び出し例（TypeScript）
const response = await fetch('/api/inventory', {
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});
const data = await response.json();
```

### 画面設計優先順位
1. **ログイン画面** - JWT認証
2. **ダッシュボード** - 各種サマリー表示
3. **在庫管理画面** - 一覧・詳細・更新
4. **統合入荷処理画面** - 新APIの活用
5. **予定入荷管理画面** - 発注〜入荷フロー
6. **生産計画画面** - 計画登録・所要量計算

## 📚 重要な技術知識

### JWT認証実装
- **トークン保存**: localStorage推奨（開発用）
- **自動更新**: リフレッシュトークン実装推奨
- **権限制御**: ルートガード実装

### エラーハンドリング
- **401 Unauthorized**: ログイン画面リダイレクト
- **403 Forbidden**: 権限不足メッセージ
- **500 Server Error**: 汎用エラーメッセージ

### データ型定義（TypeScript用）
```typescript
// 基本レスポンス型
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message: string;
  error?: string;
}

// 在庫データ型
interface InventoryItem {
  part_code: string;
  current_stock: number;
  reserved_stock: number;
  available_stock: number;
  // ...
}
```

## 🚀 次のフェーズ

### フロントエンド開発計画
1. **Phase 1**: Next.js環境構築・認証実装
2. **Phase 2**: 基本CRUD画面実装
3. **Phase 3**: 統合入荷処理UI実装
4. **Phase 4**: ダッシュボード・分析画面
5. **Phase 5**: レスポンシブ対応・最適化

### 後回しにした機能（フロントエンド完成後）
- 棚おろし機能統合
- 共通処理抽出・ユーティリティ化
- BOM展開処理最適化
- 高度な分析機能

## 🛠 開発環境情報

### Docker環境
```bash
# サーバー起動
docker-compose up -d

# ログ確認
docker-compose logs -f

# データベース接続
docker exec -it inventory_mysql mysql -u root -p inventory_db
```

### 重要ファイル
- `src/routes/inventory.js` - 統合入荷処理API実装
- `src/middleware/auth.js` - 認証・権限管理
- `sql/` - データベース初期設定・テストデータ

---

## 📝 学習ポイント

### 解決した主要課題
1. **2段階処理問題** → 統合API実装
2. **認証・権限管理** → JWT + ロールベース実装
3. **データ整合性** → トランザクション保証
4. **API設計統一** → 全ファイル統一パターン適用

### 技術スキル習得
- Node.js/Express.js アプリケーション設計
- MySQL データベース設計・操作
- JWT認証システム実装
- RESTful API設計・実装
- Docker環境構築
- エラーハンドリング・ロギング