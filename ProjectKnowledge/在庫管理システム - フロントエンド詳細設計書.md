# 在庫管理システム - フロントエンド詳細設計書

## 🎯 設計概要

### システム全体像
- **バックエンド**: Node.js + Express + MySQL（完成済み）
- **フロントエンド**: Next.js 15.4.4 + React 19 + TypeScript 5.7
- **API**: JWT認証 + 4段階権限管理 + 統合入荷処理API
- **Docker環境**: フロントエンド（ポート3001）、バックエンド（ポート3000）

### 技術スタック
```typescript
// フロントエンド技術構成
Framework: Next.js 15.4.4 (App Router)
UI Library: React 19.0.0
Language: TypeScript 5.7.0
Styling: Tailwind CSS 3.4.15
State Management: React Context API + Custom Hooks
API Client: Fetch API + Custom API Class
Form Management: React Hook Form (予定)
Data Visualization: Recharts (予定)
Testing: Jest + React Testing Library (予定)
```

---

## 📂 フォルダ構成設計

```
src/
├── app/                         # App Router (Next.js 15)
│   ├── (auth)/                 # 認証関連画面（Route Groups）
│   │   └── login/              # ログイン画面
│   │       └── page.tsx
│   ├── dashboard/              # ダッシュボード
│   │   └── page.tsx
│   ├── inventory/              # 在庫管理
│   │   ├── page.tsx           # 在庫管理トップ
│   │   ├── list/              # 在庫一覧
│   │   │   └── page.tsx
│   │   ├── receipt/           # 入荷処理
│   │   │   └── page.tsx
│   │   ├── transactions/      # 在庫履歴
│   │   │   └── page.tsx
│   │   └── loading.tsx        # ローディングUI
│   ├── production/             # 生産計画管理
│   │   ├── page.tsx
│   │   ├── plans/             # 計画一覧・登録
│   │   │   ├── page.tsx
│   │   │   ├── create/
│   │   │   │   └── page.tsx
│   │   │   └── [id]/
│   │   │       └── page.tsx
│   │   └── requirements/      # 所要量計算
│   │       └── page.tsx
│   ├── procurement/            # 調達管理
│   │   ├── page.tsx
│   │   ├── scheduled-receipts/ # 予定入荷管理
│   │   │   ├── page.tsx
│   │   │   ├── create/
│   │   │   │   └── page.tsx
│   │   │   └── [id]/
│   │   │       └── page.tsx
│   │   └── alerts/            # 発注アラート
│   │       └── page.tsx
│   ├── masters/               # マスタ管理
│   │   ├── page.tsx
│   │   ├── parts/             # 部品マスタ
│   │   │   ├── page.tsx
│   │   │   ├── create/
│   │   │   │   └── page.tsx
│   │   │   └── [id]/
│   │   │       └── page.tsx
│   │   ├── products/          # 製品マスタ
│   │   │   └── page.tsx
│   │   └── bom/               # BOM管理
│   │       └── page.tsx
│   ├── reports/               # 帳票・レポート
│   │   ├── page.tsx
│   │   ├── dashboard/
│   │   │   └── page.tsx
│   │   ├── inventory/
│   │   │   └── page.tsx
│   │   └── shortage/
│   │       └── page.tsx
│   ├── layout.tsx             # 共通レイアウト
│   ├── page.tsx              # トップページ（ダッシュボード）
│   ├── globals.css           # グローバルスタイル
│   ├── loading.tsx           # 共通ローディング
│   ├── error.tsx             # 共通エラー
│   └── not-found.tsx         # 404ページ
├── components/                # 再利用可能コンポーネント
│   ├── ui/                   # 基本UIコンポーネント
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   ├── Table.tsx
│   │   ├── Modal.tsx
│   │   ├── Alert.tsx
│   │   ├── Badge.tsx
│   │   ├── Input.tsx
│   │   ├── Select.tsx
│   │   ├── Textarea.tsx
│   │   ├── Checkbox.tsx
│   │   ├── Radio.tsx
│   │   ├── Switch.tsx
│   │   ├── Tabs.tsx
│   │   ├── Pagination.tsx
│   │   ├── Spinner.tsx
│   │   └── Tooltip.tsx
│   ├── forms/                # フォーム関連
│   │   ├── LoginForm.tsx
│   │   ├── InventoryForm.tsx
│   │   ├── InventoryReceiptForm.tsx
│   │   ├── ProductionPlanForm.tsx
│   │   ├── ScheduledReceiptForm.tsx
│   │   ├── PartForm.tsx
│   │   └── BOMForm.tsx
│   ├── tables/               # テーブル関連
│   │   ├── InventoryTable.tsx
│   │   ├── ProductionPlanTable.tsx
│   │   ├── ScheduledReceiptTable.tsx
│   │   ├── TransactionTable.tsx
│   │   ├── PartTable.tsx
│   │   └── DataTable.tsx     # 汎用テーブル
│   ├── charts/               # グラフ・チャート
│   │   ├── InventoryChart.tsx
│   │   ├── DashboardCharts.tsx
│   │   ├── ProductionChart.tsx
│   │   └── TrendChart.tsx
│   ├── layout/               # レイアウトコンポーネント
│   │   ├── Header.tsx
│   │   ├── Sidebar.tsx
│   │   ├── Breadcrumb.tsx
│   │   ├── Navigation.tsx
│   │   └── Footer.tsx
│   ├── guards/               # 権限制御
│   │   ├── RouteGuard.tsx
│   │   └── PermissionGuard.tsx
│   └── providers/            # Provider系
│       ├── AuthProvider.tsx
│       └── QueryProvider.tsx
├── hooks/                    # カスタムフック
│   ├── useAuth.ts           # 認証管理
│   ├── usePermissions.ts    # 権限管理
│   ├── useApi.ts            # API呼び出し
│   ├── useInventory.ts      # 在庫関連
│   ├── useProduction.ts     # 生産計画関連
│   ├── useProcurement.ts    # 調達関連
│   ├── useParts.ts          # 部品マスタ関連
│   ├── useReports.ts        # レポート関連
│   ├── useLocalStorage.ts   # ローカルストレージ
│   ├── useDebounce.ts       # デバウンス
│   └── usePagination.ts     # ページネーション
├── lib/                     # ユーティリティ・設定
│   ├── api.ts              # API基本設定
│   ├── auth.ts             # 認証関連
│   ├── constants.ts        # 定数定義
│   ├── utils.ts            # 汎用関数
│   ├── validations.ts      # バリデーション
│   ├── formatters.ts       # データフォーマット
│   └── date.ts             # 日付操作
├── types/                   # TypeScript型定義
│   ├── api.ts              # API関連型
│   ├── auth.ts             # 認証関連型
│   ├── inventory.ts        # 在庫関連型
│   ├── production.ts       # 生産計画関連型
│   ├── procurement.ts      # 調達関連型
│   ├── parts.ts            # 部品関連型
│   ├── reports.ts          # レポート関連型
│   └── common.ts           # 共通型
├── constants/               # 定数・設定
│   ├── api-endpoints.ts    # APIエンドポイント
│   ├── permissions.ts      # 権限定義
│   ├── routes.ts           # ルート定義
│   ├── messages.ts         # メッセージ定義
│   └── status.ts           # ステータス定義
├── utils/                   # ヘルパー関数
│   ├── formatters.ts       # データフォーマット
│   ├── validators.ts       # バリデーション
│   ├── converters.ts       # データ変換
│   ├── calculations.ts     # 計算処理
│   └── exports.ts          # エクスポート機能
└── services/                # API通信ロジック
    ├── auth.service.ts     # 認証API
    ├── inventory.service.ts # 在庫API
    ├── production.service.ts # 生産計画API
    ├── procurement.service.ts # 調達API
    ├── parts.service.ts    # 部品マスタAPI
    └── reports.service.ts  # レポートAPI
```

---

## 🔐 認証・権限設計

### 権限レベル定義
```typescript
export type UserRole = 'admin' | 'production_manager' | 'material_staff' | 'viewer'

interface User {
  id: number
  username: string
  email: string
  role: UserRole
  name: string
}

// 権限マトリックス
const PERMISSION_MATRIX = {
  admin: {
    inventory: ['view', 'create', 'update', 'delete'],
    production: ['view', 'create', 'update', 'delete'],
    procurement: ['view', 'create', 'update', 'delete'],
    masters: ['view', 'create', 'update', 'delete'],
    reports: ['view', 'export'],
    system: ['users', 'settings']
  },
  production_manager: {
    inventory: ['view'],
    production: ['view', 'create', 'update', 'delete'],
    procurement: ['view'],
    masters: ['view'],
    reports: ['view', 'export']
  },
  material_staff: {
    inventory: ['view', 'create', 'update'],
    production: ['view'],
    procurement: ['view', 'create', 'update'],
    masters: ['view'],
    reports: ['view', 'export']
  },
  viewer: {
    inventory: ['view'],
    production: ['view'],
    procurement: ['view'],
    masters: ['view'],
    reports: ['view']
  }
} as const
```

### 認証フロー設計
```typescript
// 1. ログイン
POST /api/auth/login
Request: { username: string, password: string }
Response: {
  success: boolean
  data: {
    user: User
    tokens: {
      accessToken: string
      refreshToken: string
      expiresIn: string
    }
  }
}

// 2. トークン検証
GET /api/auth/me
Headers: { Authorization: "Bearer <token>" }
Response: { success: boolean, data: { user: User } }

// 3. ログアウト
POST /api/auth/logout
Headers: { Authorization: "Bearer <token>" }
Response: { success: boolean, message: string }
```

### 権限制御コンポーネント設計
```typescript
// ページレベル制御
<RouteGuard requireAuth={true} allowedRoles={['admin', 'material_staff']}>
  <InventoryPage />
</RouteGuard>

// UIレベル制御
<PermissionGuard requiredPermissions={['inventory.create']}>
  <Button>新規登録</Button>
</PermissionGuard>

// 便利なショートカット
<AdminOnly>
  <AdminPanel />
</AdminOnly>

<MaterialStaffOnly>
  <InventoryForm />
</MaterialStaffOnly>
```

---

## 📡 API連携設計

### API基盤クラス設計
```typescript
class ApiClient {
  private baseURL: string
  private getToken(): string | null
  private request<T>(endpoint: string, options?: RequestOptions): Promise<ApiResponse<T>>
  
  // HTTP Methods
  async get<T>(endpoint: string, requireAuth?: boolean): Promise<ApiResponse<T>>
  async post<T>(endpoint: string, body?: any, requireAuth?: boolean): Promise<ApiResponse<T>>
  async put<T>(endpoint: string, body?: any, requireAuth?: boolean): Promise<ApiResponse<T>>
  async delete<T>(endpoint: string, requireAuth?: boolean): Promise<ApiResponse<T>>
  
  // 認証関連
  isAuthenticated(): boolean
  getCurrentUser(): User | null
  logout(): void
}

// 使用例
const api = new ApiClient('http://localhost:3000')
const inventory = await api.get<InventoryItem[]>('/api/inventory')
```

### 主要APIエンドポイント
```typescript
// 認証API
POST /api/auth/login
GET /api/auth/me
POST /api/auth/logout

// 在庫管理API
GET /api/inventory                               # 在庫一覧
GET /api/inventory/:part_code                    # 在庫詳細
POST /api/inventory/:part_code/integrated-receipt # 統合入荷処理
POST /api/inventory/:part_code/issue             # 出庫処理
GET /api/inventory/:part_code/transactions       # 在庫履歴

// 予定入荷API
GET /api/scheduled-receipts                      # 予定入荷一覧
POST /api/scheduled-receipts                     # 発注登録
PUT /api/scheduled-receipts/:id                  # 予定入荷更新
DELETE /api/scheduled-receipts/:id               # 予定入荷削除

// 生産計画API
GET /api/plans                                   # 生産計画一覧
POST /api/plans                                  # 生産計画登録
PUT /api/plans/:id                               # 生産計画更新
POST /api/plans/:id/requirements                 # 所要量計算

// 部品マスタAPI
GET /api/parts                                   # 部品一覧
POST /api/parts                                  # 部品登録
PUT /api/parts/:id                               # 部品更新
DELETE /api/parts/:id                            # 部品削除

// レポートAPI
GET /api/reports/dashboard                       # ダッシュボード
GET /api/reports/shortage-parts                  # 不足部品レポート
GET /api/reports/inventory-summary               # 在庫サマリー
```

### 統合入荷処理API設計
```typescript
// 統合入荷処理（最重要機能）
interface IntegratedReceiptRequest {
  quantity: number
  supplier: string
  receipt_date: string
  scheduled_receipt_id?: number  // 予定入荷連携時のみ
  remarks?: string
}

interface IntegratedReceiptResponse {
  success: boolean
  data: {
    transaction_id: number
    updated_inventory: InventoryItem
    updated_scheduled_receipt?: ScheduledReceipt
  }
  message: string
}

// API呼び出し例
const result = await api.post<IntegratedReceiptResponse>(
  `/api/inventory/${partCode}/integrated-receipt`,
  {
    quantity: 50,
    supplier: "Sample Supplier",
    receipt_date: "2025-08-15",
    scheduled_receipt_id: 123,
    remarks: "統合入荷処理"
  }
)
```

---

## 🎨 UI/UX設計

### デザインシステム
```typescript
// カラーパレット
const colors = {
  primary: {
    50: '#eff6ff',
    500: '#3b82f6',
    600: '#2563eb',
    700: '#1d4ed8'
  },
  success: {
    50: '#f0fdf4',
    500: '#22c55e',
    600: '#16a34a'
  },
  warning: {
    50: '#fffbeb',
    500: '#f59e0b',
    600: '#d97706'
  },
  danger: {
    50: '#fef2f2',
    500: '#ef4444',
    600: '#dc2626'
  }
}

// コンポーネントクラス
.btn-primary     # プライマリボタン
.btn-secondary   # セカンダリボタン
.btn-danger      # 危険操作ボタン
.card-base       # カード型コンテナ
.input-base      # 入力フィールド
.table-base      # テーブル
```

### レスポンシブ設計
```typescript
// ブレークポイント
const breakpoints = {
  sm: '640px',   // タブレット（縦）
  md: '768px',   // タブレット（横）
  lg: '1024px',  // デスクトップ（小）
  xl: '1280px',  // デスクトップ（大）
  '2xl': '1536px' // ワイドスクリーン
}

// 対応方針
Desktop First: 1280px以上を基準に設計
Tablet: 768px-1279px（主要機能対応）
Mobile: 767px以下（基本機能のみ）
```

### コンポーネント設計パターン
```typescript
// Compound Component Pattern
<DataTable>
  <DataTable.Header>
    <DataTable.Column sortable>部品コード</DataTable.Column>
    <DataTable.Column>部品名</DataTable.Column>
  </DataTable.Header>
  <DataTable.Body>
    {data.map(item => (
      <DataTable.Row key={item.id}>
        <DataTable.Cell>{item.code}</DataTable.Cell>
        <DataTable.Cell>{item.name}</DataTable.Cell>
      </DataTable.Row>
    ))}
  </DataTable.Body>
</DataTable>

// Render Props Pattern
<DataProvider
  query="/api/inventory"
  render={({ data, loading, error }) => (
    <InventoryTable data={data} loading={loading} error={error} />
  )}
/>
```

---

## 📱 画面設計仕様

### ナビゲーション設計
```typescript
interface NavigationItem {
  id: string
  label: string
  icon: string
  path: string
  requiredPermissions?: string[]
  children?: NavigationItem[]
}

const navigationItems: NavigationItem[] = [
  {
    id: 'dashboard',
    label: 'ダッシュボード',
    icon: 'dashboard',
    path: '/dashboard'
  },
  {
    id: 'inventory',
    label: '在庫管理',
    icon: 'inventory',
    path: '/inventory',
    requiredPermissions: ['inventory.view'],
    children: [
      { id: 'inventory-list', label: '在庫一覧', path: '/inventory/list' },
      { id: 'inventory-receipt', label: '入荷処理', path: '/inventory/receipt', requiredPermissions: ['inventory.create'] },
      { id: 'inventory-transactions', label: '在庫履歴', path: '/inventory/transactions' }
    ]
  },
  {
    id: 'production',
    label: '生産計画',
    icon: 'production',
    path: '/production',
    requiredPermissions: ['production.view'],
    children: [
      { id: 'production-plans', label: '計画一覧', path: '/production/plans' },
      { id: 'production-requirements', label: '所要量計算', path: '/production/requirements' }
    ]
  },
  {
    id: 'procurement',
    label: '調達管理',
    icon: 'procurement',
    path: '/procurement',
    requiredPermissions: ['procurement.view'],
    children: [
      { id: 'scheduled-receipts', label: '予定入荷', path: '/procurement/scheduled-receipts' },
      { id: 'procurement-alerts', label: '発注アラート', path: '/procurement/alerts' }
    ]
  },
  {
    id: 'masters',
    label: 'マスタ管理',
    icon: 'masters',
    path: '/masters',
    requiredPermissions: ['masters.view'],
    children: [
      { id: 'parts', label: '部品マスタ', path: '/masters/parts' },
      { id: 'products', label: '製品マスタ', path: '/masters/products' },
      { id: 'bom', label: 'BOM管理', path: '/masters/bom' }
    ]
  },
  {
    id: 'reports',
    label: 'レポート',
    icon: 'reports',
    path: '/reports',
    requiredPermissions: ['reports.view']
  }
]
```

### レイアウト設計
```typescript
// メインレイアウト構成
<RootLayout>
  <Header>
    <Logo />
    <Navigation />
    <UserMenu />
  </Header>
  
  <Sidebar>
    <MainNavigation items={navigationItems} />
  </Sidebar>
  
  <Main>
    <Breadcrumb />
    <PageContent>
      {children}
    </PageContent>
  </Main>
  
  <Footer>
    <SystemInfo />
  </Footer>
</RootLayout>
```

---

## 🛠 技術実装方針

### 状態管理設計
```typescript
// 認証状態: React Context API
interface AuthState {
  user: User | null
  isLoading: boolean
  isAuthenticated: boolean
}

// API状態: TanStack Query（推奨）
const { data, isLoading, error, refetch } = useQuery({
  queryKey: ['inventory', filters],
  queryFn: () => inventoryService.getList(filters),
  staleTime: 5 * 60 * 1000, // 5分間キャッシュ
})

// フォーム状態: React Hook Form
const {
  register,
  handleSubmit,
  formState: { errors },
  reset
} = useForm<InventoryReceiptForm>({
  resolver: zodResolver(inventoryReceiptSchema)
})

// ローカル状態: useState
const [filters, setFilters] = useState<InventoryFilters>({})
```

### データフェッチング設計
```typescript
// サービス層設計
class InventoryService {
  async getList(filters?: InventoryFilters): Promise<InventoryItem[]>
  async getDetail(partCode: string): Promise<InventoryItem>
  async integratedReceipt(partCode: string, data: IntegratedReceiptRequest): Promise<IntegratedReceiptResponse>
  async getTransactions(partCode: string): Promise<Transaction[]>
}

// カスタムフック設計
export function useInventory() {
  const getList = useCallback(async (filters?: InventoryFilters) => {
    return await inventoryService.getList(filters)
  }, [])

  const integratedReceipt = useCallback(async (partCode: string, data: IntegratedReceiptRequest) => {
    return await inventoryService.integratedReceipt(partCode, data)
  }, [])

  return { getList, integratedReceipt }
}
```

### エラーハンドリング設計
```typescript
// エラー境界コンポーネント
<ErrorBoundary fallback={<ErrorFallback />}>
  <InventoryPage />
</ErrorBoundary>

// APIエラー処理
try {
  const result = await api.post('/api/inventory/receipt', data)
} catch (error) {
  if (error.status === 401) {
    // 認証エラー → ログイン画面へ
    router.push('/login')
  } else if (error.status === 403) {
    // 権限エラー → 権限不足メッセージ
    showError('この操作を実行する権限がありません')
  } else {
    // その他エラー → 汎用エラーメッセージ
    showError('処理中にエラーが発生しました')
  }
}
```

### パフォーマンス最適化設計
```typescript
// 仮想化（大量データ対応）
import { FixedSizeList as List } from 'react-window'

// 遅延ローディング
const InventoryDetail = lazy(() => import('./InventoryDetail'))

// メモ化
const MemoizedInventoryTable = memo(InventoryTable, (prevProps, nextProps) => {
  return prevProps.data === nextProps.data
})

// 無限スクロール
const { data, fetchNextPage, hasNextPage } = useInfiniteQuery({
  queryKey: ['inventory'],
  queryFn: ({ pageParam = 0 }) => inventoryService.getList({ page: pageParam }),
  getNextPageParam: (lastPage, pages) => lastPage.hasMore ? pages.length : undefined
})
```

---

## 📊 型定義設計

### 共通型定義
```typescript
// API関連
interface ApiResponse<T = any> {
  success: boolean
  data?: T
  message: string
  error?: string
}

interface PaginationParams {
  page: number
  limit: number
  sort?: string
  order?: 'asc' | 'desc'
}

interface PaginatedResponse<T> {
  items: T[]
  total: number
  page: number
  limit: number
  totalPages: number
}

// 在庫関連
interface InventoryItem {
  part_code: string
  part_name: string
  current_stock: number
  reserved_stock: number
  available_stock: number
  safety_stock: number
  location: string
  unit: string
  unit_price: number
  last_receipt_date: string | null
  last_issue_date: string | null
  created_at: string
  updated_at: string
}

interface InventoryFilters {
  search?: string
  location?: string
  low_stock?: boolean
  category?: string
}

// 取引履歴
interface Transaction {
  id: number
  part_code: string
  transaction_type: 'receipt' | 'issue' | 'adjustment'
  quantity: number
  unit_price: number
  supplier?: string
  reference_id?: string
  remarks?: string
  created_at: string
  created_by: string
}

// 生産計画関連
interface ProductionPlan {
  id: number
  product_code: string
  product_name: string
  planned_quantity: number
  planned_start_date: string
  planned_end_date: string
  status: 'planned' | 'in_progress' | 'completed' | 'cancelled'
  priority: number
  created_at: string
  updated_at: string
}

// 予定入荷関連
interface ScheduledReceipt {
  id: number
  part_code: string
  part_name: string
  ordered_quantity: number
  received_quantity: number
  remaining_quantity: number
  supplier: string
  order_date: string
  promised_date: string
  actual_date?: string
  status: 'ordered' | 'confirmed' | 'shipped' | 'received' | 'cancelled'
  unit_price: number
  total_amount: number
  created_at: string
  updated_at: string
}
```

---

## 🚀 開発フェーズ計画

### Phase 1: 認証・基盤（完了予定）
- [ ] 認証システム実装
- [ ] 権限制御システム実装
- [ ] 共通レイアウト実装
- [ ] 基本UIコンポーネント実装

### Phase 2: 在庫管理（最優先）
- [ ] 在庫一覧画面
- [ ] 統合入荷処理画面
- [ ] 在庫履歴画面
- [ ] 在庫検索・フィルタ機能

### Phase 3: 生産計画管理
- [ ] 生産計画一覧画面
- [ ] 生産計画作成・編集画面
- [ ] 所要量計算機能
- [ ] BOM展開機能

### Phase 4: 調達管理
- [ ] 予定入荷管理画面
- [ ] 発注登録画面
- [ ] 発注アラート機能
- [ ] サプライヤー管理

### Phase 5: マスタ管理・レポート
- [ ] 部品マスタ管理
- [ ] 製品マスタ管理
- [ ] BOM管理
- [ ] ダッシュボード強化
- [ ] 各種レポート機能

### Phase 6: 最適化・運用
- [ ] パフォーマンス最適化
- [ ] テスト実装
- [ ] ドキュメント整備
- [ ] 本番デプロイ準備

---

この設計書に基づいて、段階的にフロントエンド実装を進めます。

## 🧪 テスト戦略設計

### テスト分類
```typescript
// ユニットテスト
describe('InventoryService', () => {
  test('在庫一覧取得が正常に動作する', async () => {
    const mockData = [{ part_code: 'TEST001', current_stock: 100 }]
    jest.spyOn(api, 'get').mockResolvedValue({ success: true, data: mockData })
    
    const result = await inventoryService.getList()
    expect(result).toEqual(mockData)
  })
})

// 統合テスト
describe('InventoryPage', () => {
  test('在庫一覧が正しく表示される', async () => {
    render(<InventoryPage />)
    
    await waitFor(() => {
      expect(screen.getByText('SUS304-M6-25-HEX')).toBeInTheDocument()
    })
  })
})

// E2Eテスト（Playwright推奨）
test('統合入荷処理フローが正常に完了する', async ({ page }) => {
  await page.goto('/inventory/receipt')
  await page.fill('[data-testid=part-code]', 'TEST001')
  await page.fill('[data-testid=quantity]', '50')
  await page.click('[data-testid=submit-button]')
  
  await expect(page.locator('[data-testid=success-message]')).toBeVisible()
})
```

### テスト実装方針
- **ユニットテスト**: Jest + React Testing Library
- **統合テスト**: MSW (Mock Service Worker)
- **E2Eテスト**: Playwright
- **視覚回帰テスト**: Chromatic (Storybook)
- **カバレッジ目標**: 80%以上

---

## 🔧 開発ツール設定

### 開発環境設定
```json
// package.json（追加予定依存関係）
{
  "dependencies": {
    "@hookform/resolvers": "^3.3.2",
    "@tanstack/react-query": "^5.8.4",
    "react-hook-form": "^7.47.0",
    "recharts": "^2.8.0",
    "react-window": "^1.8.8",
    "zod": "^3.22.4",
    "date-fns": "^2.30.0",
    "lucide-react": "^0.294.0"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.1.4",
    "@testing-library/react": "^13.4.0",
    "@testing-library/user-event": "^14.5.1",
    "@playwright/test": "^1.40.0",
    "@storybook/react": "^7.5.3",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "msw": "^2.0.8"
  }
}
```

### ESLint/Prettier設定
```javascript
// .eslintrc.js
module.exports = {
  extends: [
    'next/core-web-vitals',
    '@typescript-eslint/recommended',
    'prettier'
  ],
  rules: {
    '@typescript-eslint/no-unused-vars': 'error',
    '@typescript-eslint/explicit-function-return-type': 'warn',
    'react-hooks/exhaustive-deps': 'error'
  }
}

// .prettierrc
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

### Git フック設定
```json
// .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npm run lint
npm run type-check
npm run test:unit
```

---

## 📦 デプロイ設計

### 環境分離
```typescript
// 環境設定
const config = {
  development: {
    API_URL: 'http://localhost:3000',
    APP_URL: 'http://localhost:3001',
    LOG_LEVEL: 'debug'
  },
  staging: {
    API_URL: 'https://staging-api.inventory-system.com',
    APP_URL: 'https://staging.inventory-system.com',
    LOG_LEVEL: 'info'
  },
  production: {
    API_URL: 'https://api.inventory-system.com',
    APP_URL: 'https://inventory-system.com',
    LOG_LEVEL: 'error'
  }
}
```

### Docker設定
```dockerfile
# Dockerfile.frontend（本番用）
FROM node:18-alpine AS base

# 依存関係インストール
FROM base AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# ビルド
FROM base AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN npm run build

# 実行
FROM base AS runner
WORKDIR /app
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

### CI/CD パイプライン
```yaml
# .github/workflows/deploy.yml
name: Deploy Frontend

on:
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test:unit
      - run: npm run test:e2e

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t inventory-frontend .
      - run: docker push registry/inventory-frontend:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - run: kubectl set image deployment/frontend frontend=registry/inventory-frontend:${{ github.sha }}
```

---

## 🔍 監視・ログ設計

### エラー監視
```typescript
// エラー追跡設定
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
})

// カスタムエラー境界
class ErrorBoundary extends Component {
  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    Sentry.captureException(error, { contexts: { react: errorInfo } })
  }
}
```

### パフォーマンス監視
```typescript
// Web Vitals 監視
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals'

function sendToAnalytics(metric: Metric) {
  // Google Analytics 4 または独自分析基盤に送信
  gtag('event', metric.name, {
    value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
    event_label: metric.id,
  })
}

getCLS(sendToAnalytics)
getFID(sendToAnalytics)
getFCP(sendToAnalytics)
getLCP(sendToAnalytics)
getTTFB(sendToAnalytics)
```

### ログ設計
```typescript
// 構造化ログ
interface LogEntry {
  timestamp: string
  level: 'debug' | 'info' | 'warn' | 'error'
  message: string
  userId?: string
  action?: string
  metadata?: Record<string, any>
}

class Logger {
  static info(message: string, metadata?: Record<string, any>): void {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level: 'info',
      message,
      userId: getCurrentUser()?.id?.toString(),
      metadata
    }
    console.log(JSON.stringify(entry))
  }

  static error(message: string, error?: Error, metadata?: Record<string, any>): void {
    const entry: LogEntry = {
      timestamp: new Date().toISOString(),
      level: 'error',
      message,
      userId: getCurrentUser()?.id?.toString(),
      metadata: {
        ...metadata,
        error: error?.message,
        stack: error?.stack
      }
    }
    console.error(JSON.stringify(entry))
    
    // エラー監視サービスに送信
    if (error) Sentry.captureException(error, { extra: metadata })
  }
}
```

---

## 📚 ドキュメント設計

### Storybook設定
```typescript
// .storybook/main.ts
import type { StorybookConfig } from '@storybook/react'

const config: StorybookConfig = {
  stories: ['../src/**/*.stories.@(js|jsx|ts|tsx|mdx)'],
  addons: [
    '@storybook/addon-essentials',
    '@storybook/addon-a11y',
    '@storybook/addon-docs'
  ],
  framework: {
    name: '@storybook/react-webpack5',
    options: {}
  }
}

export default config
```

### コンポーネントドキュメント例
```typescript
// Button.stories.tsx
import type { Meta, StoryObj } from '@storybook/react'
import { Button } from './Button'

const meta: Meta<typeof Button> = {
  title: 'UI/Button',
  component: Button,
  parameters: {
    docs: {
      description: {
        component: 'プライマリアクション用のボタンコンポーネント'
      }
    }
  },
  argTypes: {
    variant: {
      control: 'select',
      options: ['primary', 'secondary', 'danger']
    }
  }
}

export default meta
type Story = StoryObj<typeof Button>

export const Primary: Story = {
  args: {
    variant: 'primary',
    children: '保存'
  }
}

export const WithPermission: Story = {
  args: {
    variant: 'primary',
    children: '削除',
    requiredPermissions: ['inventory.delete']
  },
  parameters: {
    docs: {
      description: {
        story: '権限制御機能付きのボタン例'
      }
    }
  }
}
```

### API ドキュメント
```typescript
// 型定義からAPIドキュメント自動生成
/**
 * 統合入荷処理API
 * 
 * @route POST /api/inventory/:part_code/integrated-receipt
 * @param part_code - 部品コード
 * @body IntegratedReceiptRequest
 * @returns IntegratedReceiptResponse
 * @requires permissions: inventory.create
 * @example
 * ```typescript
 * const result = await api.post('/api/inventory/SUS304-M6-25-HEX/integrated-receipt', {
 *   quantity: 50,
 *   supplier: 'Sample Supplier',
 *   receipt_date: '2025-08-15'
 * })
 * ```
 */
```

---

## 🚀 実装優先順位

### フェーズ別詳細計画

#### Phase 1: 基盤強化（Week 1-2）
1. **共通UIコンポーネント**
   - Button, Input, Select, Modal, Alert
   - Table, Pagination, Loading, Error
   - Form validation with React Hook Form + Zod

2. **レイアウトシステム**
   - Header（ナビゲーション、ユーザーメニュー）
   - Sidebar（メインナビゲーション、権限制御）
   - Breadcrumb（パンくずナビ）

3. **データ管理基盤**
   - TanStack Query セットアップ
   - Service layer 実装
   - Error boundary, Loading states

#### Phase 2: 在庫管理（Week 3-5）
1. **在庫一覧画面** `/inventory/list`
   - 検索・フィルタ機能
   - ソート・ページネーション
   - 在庫アラート表示
   - CSV エクスポート

2. **統合入荷処理画面** `/inventory/receipt`
   - 部品コード検索
   - 予定入荷連携
   - バーコードスキャン対応準備
   - 処理結果確認

3. **在庫履歴画面** `/inventory/transactions`
   - 取引履歴表示
   - 詳細フィルタ
   - 期間指定検索

#### Phase 3: ダッシュボード（Week 6-7）
1. **KPI ダッシュボード**
   - 在庫状況サマリー
   - 不足部品アラート
   - 最近の活動
   - チャート・グラフ表示

2. **レスポンシブ対応**
   - モバイル・タブレット最適化
   - タッチ操作対応

#### Phase 4: 生産計画（Week 8-10）
1. **生産計画管理**
   - 計画一覧・作成・編集
   - 所要量計算
   - 在庫予約機能

2. **BOM 管理**
   - BOM 表示・編集
   - 部品展開

#### Phase 5: 調達管理（Week 11-12）
1. **予定入荷管理**
   - 発注登録・更新
   - 納期管理
   - サプライヤー連携

2. **発注アラート**
   - 自動発注提案
   - 在庫不足警告

#### Phase 6: マスタ管理（Week 13-14）
1. **部品マスタ**
   - 部品登録・更新・削除
   - 一括インポート

2. **ユーザー管理**（管理者のみ）
   - ユーザー CRUD
   - 権限設定

#### Phase 7: 最適化・運用（Week 15-16）
1. **パフォーマンス最適化**
   - 仮想化実装
   - 画像最適化
   - Bundle サイズ最適化

2. **テスト・品質保証**
   - テストカバレッジ向上
   - E2E テスト実装
   - アクセシビリティ対応

3. **運用準備**
   - 監視・ログ設定
   - デプロイメント自動化
   - ドキュメント整備

---

## 📋 成果物・納品物

### コードベース
- [ ] Next.js アプリケーション
- [ ] TypeScript 型定義
- [ ] Storybook コンポーネントライブラリ
- [ ] テストスイート（Unit/Integration/E2E）

### ドキュメント
- [ ] API 仕様書
- [ ] コンポーネント仕様書
- [ ] 運用マニュアル
- [ ] 開発ガイドライン

### インフラ
- [ ] Docker 設定
- [ ] CI/CD パイプライン
- [ ] 監視・ログ設定
- [ ] セキュリティ設定
